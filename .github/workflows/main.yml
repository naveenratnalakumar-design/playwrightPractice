name: Playwright Automated Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    container:
      image: mcr.microsoft.com/playwright:v1.41.0-jammy

    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run Playwright tests
        run: |
          npx playwright test ./tests/SwagLabs.spec.js --reporter=json > playwright-report.json

      - name: Generate Test Summary Table
        if: always()
        run: |
          echo "## Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Case Name | Status | Duration (sec) |" >> $GITHUB_STEP_SUMMARY
          echo "| -------------- | ------ | -------------- |" >> $GITHUB_STEP_SUMMARY

          node <<'EOF' >> $GITHUB_STEP_SUMMARY
          const fs = require('fs');

          if (!fs.existsSync('playwright-report.json')) {
            console.log('| No report found | ‚ùå | 0 |');
            process.exit(0);
          }

          const report = JSON.parse(fs.readFileSync('playwright-report.json', 'utf8'));

          function capitalize(word = 'unknown') {
            return word.charAt(0).toUpperCase() + word.slice(1);
          }

          function walkSuites(suites = []) {
            for (const suite of suites) {
              if (suite.specs) {
                for (const spec of suite.specs) {
                  for (const test of spec.tests || []) {
                    const result = test.results?.[0];
                    const status = capitalize(result?.status);
                    const duration = result
                      ? (result.duration / 1000).toFixed(2)
                      : '0.00';

                    console.log(
                      `| ${spec.title} | ${status} | ${duration} |`
                    );
                  }
                }
              }

              if (suite.suites) {
                walkSuites(suite.suites);
              }
            }
          }

          walkSuites(report.suites);
          EOF
