name: Playwright Tests
 
on:
 workflow_dispatch:
 
jobs:

  test:

    timeout-minutes: 60

    runs-on: ubuntu-latest
 
    steps:

      - uses: actions/checkout@v4
 
      - uses: actions/setup-node@v4

        with:

          node-version: 18
 
      - name: Install dependencies

        run: npm ci

        env:

          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
 
      # Browser install step intentionally skipped
 
      - name: Run Playwright tests (JSON report)

        run: npx playwright test --reporter=json

        continue-on-error: true
 
      - name: Generate Test Summary Table

        if: always()

        run: |

          echo "## Playwright Test Results" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Test File | Test Case Name | Status | Duration (sec) |" >> $GITHUB_STEP_SUMMARY

          echo "| --------- | -------------- | ------ | -------------- |" >> $GITHUB_STEP_SUMMARY
 
          node <<'EOF'

          const fs = require('fs');
 
          const report = JSON.parse(fs.readFileSync('playwright-report.json', 'utf8'));
 
          report.suites.forEach(suite => {

            suite.suites.forEach(fileSuite => {

              const fileName = fileSuite.file.split('/').pop();
 
              fileSuite.specs.forEach(spec => {

                spec.tests.forEach(test => {

                  const result = test.results[0];

                  const status = result.status;

                  const duration = (result.duration / 1000).toFixed(2);
 
                  console.log(

                    `| ${fileName} | ${spec.title} | ${status} | ${duration} |`

                  );

                });

              });

            });

          });

          EOF >> $GITHUB_STEP_SUMMARY
 
      - name: Upload HTML Report

        if: always()

        uses: actions/upload-artifact@v4

        with:

          name: playwright-report

          path: playwright-report/

          retention-days: 30

 
