name: playwright Automated Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test ./tests/SwagLabs.spec.js

      - name: Generate Test Summary Table
        if: always()
        run: |
          echo "## Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test File | Test Case Name | Status | Duration (sec) |" >> $GITHUB_STEP_SUMMARY
          echo "| --------- | -------------- | ------ | -------------- |" >> $GITHUB_STEP_SUMMARY

          node <<'EOF' >> $GITHUB_STEP_SUMMARY
          const fs = require('fs');

          if (!fs.existsSync('playwright-report.json')) {
            console.log('| N/A | No report found | ‚ùå | 0 |');
            process.exit(0);
          }

          const report = JSON.parse(fs.readFileSync('playwright-report.json', 'utf8'));

          function walkSuites(suites = []) {
            for (const suite of suites) {
              if (suite.specs) {
                for (const spec of suite.specs) {
                  for (const test of spec.tests || []) {
                    const result = test.results?.[0];
                    const status = result?.status || 'unknown';
                    const duration = result
                      ? (result.duration / 1000).toFixed(2)
                      : '0.00';
                    const fileName = spec.file
                      ? spec.file.split('/').pop()
                      : 'N/A';

                    console.log(
                      `| ${fileName} | ${spec.title} | ${status} | ${duration} |`
                    );
                  }
                }
              }

              if (suite.suites) {
                walkSuites(suite.suites);
              }
            }
          }

          walkSuites(report.suites);
          EOF
